---
title: "Untitled"
author: "Edu Gonzalo Almorox"
date: "10/19/2017"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data

## Geographical units in England

In England the local government is organised and structured according to two main operational systems, one tier or two tier. These two levels entail different types of local authorities. On the one hand, two tier systems have the county councils, which are the upper tier and cover wider geographical areas, and the district councils that constitute the lower tier and comprise more local geograhical areas. In these two tiers, both county and district councils are in charge of different types of activities which in some cases overlap.

On the other hand, one tier systems involve unitary authorities. These are local authorities that are in charge of the provision of all the activities at local level. Besides, unitary authorities may have two special subcategories that include the metropolitan boroughs and London boroughs. 

Likewise there is an additional hierarchy, the Output Areas,  aimed to improve the reporting of small area statistics. These output areas are divided into two main layers. Middle Layer Super Output Area (MSOA) represent areas with a population of around 7200. A second level in the layer is the Lower Layer Superoutput Area (LSOA) that involves areas with around 1500 population. 

## Food hygiene ratings 

```{r, echo = FALSE, eval = TRUE, include = TRUE, warning = FALSE, message = FALSE}

library(rio)
library(dplyr)
library(tidyr)
library(ggplot2)
library(janitor)
library(viridis)
library(tidyverse)
library(readxl)


# ratings
df_ratings = import("~/Dropbox/side_projects/spatial_obesity/data/processed/ratings_clean_geo.csv")


# deprivation - district level
imd_districts = read_excel("/Users/Personas/Downloads/districts_imd.xlsx", sheet = 2)

imd_districts = clean_names(imd_districts)

##########
# Add and select information 

# get regions in england
df_ratings_clean = df_ratings %>% 
  filter(! streg %in% c(0,9, " ")) %>% 
  filter(!is.na(oslaua)) %>% # no missing districts codes
  rename(region = streg) 


# select imd average score (district level) - our variable for representing IMD
imd = imd_districts %>% select(local_authority_district_code_2013, 
                               local_authority_district_name_2013, 
                               imd_average_score)


####################
# Get frequency of businesses for each district (oslaua)
summary_business = df_ratings_clean %>% 
  group_by(oslaua, business_type, ) %>%
  crosstab(oslaua, business_type) %>% 
  adorn_crosstab(show_n = FALSE, show_totals = TRUE)

# long format
sum_long  = summary_business %>%
  gather(business, percentage, `Distributors/Transporters`:`Takeaway/sandwich shop`) %>% 
  arrange(oslaua) %>% 
  mutate(percentage = gsub("%", "", percentage)) %>%
  mutate_at(vars(percentage), funs(as.numeric))

# link deprivation data
sum_long = left_join(sum_long, imd, by = c("oslaua" = "local_authority_district_code_2013"))

# select relevant businesses
imp_businesses = sum_long %>% filter(business %in%  c("Pub/bar/nightclub", "Restaurant/Cafe/Canteen", 
                                           "Hospitals/Childcare/Caring Premises", "Takeaway/sandwich shop", 
                                           "Retailers - supermarkets/hypermarkets", "Retailers - other", 
                                           "School/college/university"))


```

Data for the analysis come from the food ratings inspections carried out by the FSA food hygiene ratings website. Our data consist of the inspections carried out in August 2017. The information contained in the website is updated daily and includes ratings corresponding to food establishments accross all the United Kingdom (i.e. Scotland, Wales, North Ireland and England). 

We construct a dataset considering only businesses based in England. There are `r length(unique(sum_long$business))` different types of businesses. The distribution of businesses is illustrated in Figure 1. 


```{r, echo = FALSE, eval = TRUE, include = TRUE, warning = FALSE}

# plot number of inspected business 
    business_freq =  df_ratings_clean %>% 
      tabyl(business_type) %>% arrange(desc(n))
    
    ggplot(business_freq, aes(x = reorder(business_type, n), y = n)) + 
      geom_bar(stat = "identity") +
      coord_flip() + 
      labs(x = "Business Type", title = "Types of inspected businesses")
      

```







